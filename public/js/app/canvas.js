define(["jquery","fabric","highpass_filter","spritesheet"],function ($,fabric) {

    var $canvas = $('#main');
    $canvas.attr({
        "width" : window.innerWidth,
        "height" : window.innerHeight
    });

    var canvas = new fabric.Canvas('main');


    canvas.freeDrawingLineWidth = 6;
        canvas.freeDrawingColor = 'rgb(255, 255, 255)';

    var img_options = {
                    threshold : 128,
                    radius : 8,
                    iterations : 1,
                    gamma : 1.7,
                    input : {
                        min:100,
                        max:180
                    },
                    output : {
                        min:0,
                        max:255
                    }
                };

    var groups = [];

    return  {
        consumeEvents : function(target) {
            var update = function() {
                var o = canvas.getActiveObject();
                if(!o) o = canvas.getActiveGroup();
                target.update('selected',o);
                target.update('exists',(canvas._objects.length > 0));
            }
            canvas.on('mouse:up',function(e){
                update();
            });
            canvas.on('object:added',function(e){
                target.update('added',e.target);
            });
            canvas.on('object:removed',function(e){
                update();
            });
        },
        addSprite : function() {
            var s = new fabric.SpriteSheet();
            var json = {
    "animations": {
        "all": {
            "frames": [
                0,
                1,
                2,
                3,
                4,
                5,
                6,
                7,
                8,
                9,
                10,
                11,
                12,
                13,
                14,
                15,
                16,
                17,
                18,
                19,
                20,
                21,
                22,
                23,
                24,
                25,
                26,
                27,
                28,
                29,
                30,
                31,
                32,
                33,
                34,
                35,
                36,
                37,
                38,
                39,
                40,
                41,
                42,
                43,
                44,
                45,
                46,
                47,
                48,
                49,
                50,
                51,
                52,
                53,
                54,
                55,
                56,
                57,
                58,
                59,
                60,
                61,
                62,
                63,
                64,
                65,
                66,
                67,
                68,
                69,
                70,
                71,
                72,
                73,
                74,
                75,
                76,
                77,
                78,
                79,
                80,
                81,
                82,
                83,
                84,
                85,
                86,
                87,
                88,
                89,
                90,
                91,
                92,
                93,
                94,
                95,
                96,
                97,
                98,
                99,
                100,
                101,
                102,
                103,
                104,
                105,
                106,
                107,
                108,
                109,
                110,
                111,
                112,
                113,
                114,
                115,
                116,
                117,
                118,
                119,
                120,
                121,
                122,
                123,
                124,
                125,
                126,
                127,
                128,
                129,
                130,
                131,
                132,
                133,
                134,
                135,
                136,
                137,
                138,
                139,
                140,
                141,
                142,
                143,
                144,
                145,
                146,
                147,
                148,
                149,
                150,
                151,
                152,
                153,
                154,
                155,
                156,
                157,
                158,
                159,
                160,
                161,
                162,
                163,
                164,
                165,
                166,
                167,
                168,
                169,
                170,
                171,
                172,
                173,
                174,
                175,
                176,
                177,
                178,
                179,
                180,
                181,
                182,
                183,
                184,
                185,
                186,
                187,
                188,
                189,
                190,
                191,
                192,
                193,
                194,
                195,
                196,
                197,
                198,
                199,
                200,
                201,
                202,
                203,
                204,
                205,
                206,
                207,
                208,
                209,
                210,
                211,
                212,
                213,
                214,
                215,
                216
            ]
        }
    },
    "images": ["uploads/AgentJokerWorldFlat_0.png", "uploads/AgentJokerWorldFlat_1.png", "uploads/AgentJokerWorldFlat_2.png", "uploads/AgentJokerWorldFlat_3.png", "uploads/AgentJokerWorldFlat_4.png", "uploads/AgentJokerWorldFlat_5.png", "uploads/AgentJokerWorldFlat_6.png"],
    "frames": [
        [2, 2, 252, 508, 0, 0, 0],
        [258, 2, 252, 508, 0, 0, 0],
        [514, 2, 252, 508, 0, 0, 0],
        [770, 2, 252, 508, 0, 0, 0],
        [1026, 2, 252, 508, 0, 0, 0],
        [1282, 2, 252, 508, 0, 0, 0],
        [1538, 2, 252, 508, 0, 0, 0],
        [1794, 2, 252, 508, 0, 0, 0],
        [2, 514, 252, 508, 0, 0, 0],
        [258, 514, 252, 508, 0, 0, 0],
        [514, 514, 252, 508, 0, 0, 0],
        [770, 514, 252, 508, 0, 0, 0],
        [1026, 514, 252, 508, 0, 0, 0],
        [1282, 514, 252, 508, 0, 0, 0],
        [1538, 514, 252, 508, 0, 0, 0],
        [1794, 514, 252, 508, 0, 0, 0],
        [2, 1026, 252, 508, 0, 0, 0],
        [258, 1026, 252, 508, 0, 0, 0],
        [514, 1026, 252, 508, 0, 0, 0],
        [770, 1026, 252, 508, 0, 0, 0],
        [1026, 1026, 252, 508, 0, 0, 0],
        [1282, 1026, 252, 508, 0, 0, 0],
        [1538, 1026, 252, 508, 0, 0, 0],
        [1794, 1026, 252, 508, 0, 0, 0],
        [2, 1538, 252, 508, 0, 0, 0],
        [258, 1538, 252, 508, 0, 0, 0],
        [514, 1538, 252, 508, 0, 0, 0],
        [770, 1538, 252, 508, 0, 0, 0],
        [1026, 1538, 252, 508, 0, 0, 0],
        [1282, 1538, 252, 508, 0, 0, 0],
        [1538, 1538, 252, 508, 0, 0, 0],
        [1794, 1538, 252, 508, 0, 0, 0],
        [2, 2, 252, 508, 1, 0, 0],
        [258, 2, 252, 508, 1, 0, 0],
        [514, 2, 252, 508, 1, 0, 0],
        [770, 2, 252, 508, 1, 0, 0],
        [1026, 2, 252, 508, 1, 0, 0],
        [1282, 2, 252, 508, 1, 0, 0],
        [1538, 2, 252, 508, 1, 0, 0],
        [1794, 2, 252, 508, 1, 0, 0],
        [2, 514, 252, 508, 1, 0, 0],
        [258, 514, 252, 508, 1, 0, 0],
        [514, 514, 252, 508, 1, 0, 0],
        [770, 514, 252, 508, 1, 0, 0],
        [1026, 514, 252, 508, 1, 0, 0],
        [1282, 514, 252, 508, 1, 0, 0],
        [1538, 514, 252, 508, 1, 0, 0],
        [1794, 514, 252, 508, 1, 0, 0],
        [2, 1026, 252, 508, 1, 0, 0],
        [258, 1026, 252, 508, 1, 0, 0],
        [514, 1026, 252, 508, 1, 0, 0],
        [770, 1026, 252, 508, 1, 0, 0],
        [1026, 1026, 252, 508, 1, 0, 0],
        [1282, 1026, 252, 508, 1, 0, 0],
        [1538, 1026, 252, 508, 1, 0, 0],
        [1794, 1026, 252, 508, 1, 0, 0],
        [2, 1538, 252, 508, 1, 0, 0],
        [258, 1538, 252, 508, 1, 0, 0],
        [514, 1538, 252, 508, 1, 0, 0],
        [770, 1538, 252, 508, 1, 0, 0],
        [1026, 1538, 252, 508, 1, 0, 0],
        [1282, 1538, 252, 508, 1, 0, 0],
        [1538, 1538, 252, 508, 1, 0, 0],
        [1794, 1538, 252, 508, 1, 0, 0],
        [2, 2, 252, 508, 2, 0, 0],
        [258, 2, 252, 508, 2, 0, 0],
        [514, 2, 252, 508, 2, 0, 0],
        [770, 2, 252, 508, 2, 0, 0],
        [1026, 2, 252, 508, 2, 0, 0],
        [1282, 2, 252, 508, 2, 0, 0],
        [1538, 2, 252, 508, 2, 0, 0],
        [1794, 2, 252, 508, 2, 0, 0],
        [2, 514, 252, 508, 2, 0, 0],
        [258, 514, 252, 508, 2, 0, 0],
        [514, 514, 252, 508, 2, 0, 0],
        [770, 514, 252, 508, 2, 0, 0],
        [1026, 514, 252, 508, 2, 0, 0],
        [1282, 514, 252, 508, 2, 0, 0],
        [1538, 514, 252, 508, 2, 0, 0],
        [1794, 514, 252, 508, 2, 0, 0],
        [2, 1026, 252, 508, 2, 0, 0],
        [258, 1026, 252, 508, 2, 0, 0],
        [514, 1026, 252, 508, 2, 0, 0],
        [770, 1026, 252, 508, 2, 0, 0],
        [1026, 1026, 252, 508, 2, 0, 0],
        [1282, 1026, 252, 508, 2, 0, 0],
        [1538, 1026, 252, 508, 2, 0, 0],
        [1794, 1026, 252, 508, 2, 0, 0],
        [2, 1538, 252, 508, 2, 0, 0],
        [258, 1538, 252, 508, 2, 0, 0],
        [514, 1538, 252, 508, 2, 0, 0],
        [770, 1538, 252, 508, 2, 0, 0],
        [1026, 1538, 252, 508, 2, 0, 0],
        [1282, 1538, 252, 508, 2, 0, 0],
        [1538, 1538, 252, 508, 2, 0, 0],
        [1794, 1538, 252, 508, 2, 0, 0],
        [2, 2, 252, 508, 3, 0, 0],
        [258, 2, 252, 508, 3, 0, 0],
        [514, 2, 252, 508, 3, 0, 0],
        [770, 2, 252, 508, 3, 0, 0],
        [1026, 2, 252, 508, 3, 0, 0],
        [1282, 2, 252, 508, 3, 0, 0],
        [1538, 2, 252, 508, 3, 0, 0],
        [1794, 2, 252, 508, 3, 0, 0],
        [2, 514, 252, 508, 3, 0, 0],
        [258, 514, 252, 508, 3, 0, 0],
        [514, 514, 252, 508, 3, 0, 0],
        [770, 514, 252, 508, 3, 0, 0],
        [1026, 514, 252, 508, 3, 0, 0],
        [1282, 514, 252, 508, 3, 0, 0],
        [1538, 514, 252, 508, 3, 0, 0],
        [1794, 514, 252, 508, 3, 0, 0],
        [2, 1026, 252, 508, 3, 0, 0],
        [258, 1026, 252, 508, 3, 0, 0],
        [514, 1026, 252, 508, 3, 0, 0],
        [770, 1026, 252, 508, 3, 0, 0],
        [1026, 1026, 252, 508, 3, 0, 0],
        [1282, 1026, 252, 508, 3, 0, 0],
        [1538, 1026, 252, 508, 3, 0, 0],
        [1794, 1026, 252, 508, 3, 0, 0],
        [2, 1538, 252, 508, 3, 0, 0],
        [258, 1538, 252, 508, 3, 0, 0],
        [514, 1538, 252, 508, 3, 0, 0],
        [770, 1538, 252, 508, 3, 0, 0],
        [1026, 1538, 252, 508, 3, 0, 0],
        [1282, 1538, 252, 508, 3, 0, 0],
        [1538, 1538, 252, 508, 3, 0, 0],
        [1794, 1538, 252, 508, 3, 0, 0],
        [2, 2, 252, 508, 4, 0, 0],
        [258, 2, 252, 508, 4, 0, 0],
        [514, 2, 252, 508, 4, 0, 0],
        [770, 2, 252, 508, 4, 0, 0],
        [1026, 2, 252, 508, 4, 0, 0],
        [1282, 2, 252, 508, 4, 0, 0],
        [1538, 2, 252, 508, 4, 0, 0],
        [1794, 2, 252, 508, 4, 0, 0],
        [2, 514, 252, 508, 4, 0, 0],
        [258, 514, 252, 508, 4, 0, 0],
        [514, 514, 252, 508, 4, 0, 0],
        [770, 514, 252, 508, 4, 0, 0],
        [1026, 514, 252, 508, 4, 0, 0],
        [1282, 514, 252, 508, 4, 0, 0],
        [1538, 514, 252, 508, 4, 0, 0],
        [1794, 514, 252, 508, 4, 0, 0],
        [2, 1026, 252, 508, 4, 0, 0],
        [258, 1026, 252, 508, 4, 0, 0],
        [514, 1026, 252, 508, 4, 0, 0],
        [770, 1026, 252, 508, 4, 0, 0],
        [1026, 1026, 252, 508, 4, 0, 0],
        [1282, 1026, 252, 508, 4, 0, 0],
        [1538, 1026, 252, 508, 4, 0, 0],
        [1794, 1026, 252, 508, 4, 0, 0],
        [2, 1538, 252, 508, 4, 0, 0],
        [258, 1538, 252, 508, 4, 0, 0],
        [514, 1538, 252, 508, 4, 0, 0],
        [770, 1538, 252, 508, 4, 0, 0],
        [1026, 1538, 252, 508, 4, 0, 0],
        [1282, 1538, 252, 508, 4, 0, 0],
        [1538, 1538, 252, 508, 4, 0, 0],
        [1794, 1538, 252, 508, 4, 0, 0],
        [2, 2, 252, 508, 5, 0, 0],
        [258, 2, 252, 508, 5, 0, 0],
        [514, 2, 252, 508, 5, 0, 0],
        [770, 2, 252, 508, 5, 0, 0],
        [1026, 2, 252, 508, 5, 0, 0],
        [1282, 2, 252, 508, 5, 0, 0],
        [1538, 2, 252, 508, 5, 0, 0],
        [1794, 2, 252, 508, 5, 0, 0],
        [2, 514, 252, 508, 5, 0, 0],
        [258, 514, 252, 508, 5, 0, 0],
        [514, 514, 252, 508, 5, 0, 0],
        [770, 514, 252, 508, 5, 0, 0],
        [1026, 514, 252, 508, 5, 0, 0],
        [1282, 514, 252, 508, 5, 0, 0],
        [1538, 514, 252, 508, 5, 0, 0],
        [1794, 514, 252, 508, 5, 0, 0],
        [2, 1026, 252, 508, 5, 0, 0],
        [258, 1026, 252, 508, 5, 0, 0],
        [514, 1026, 252, 508, 5, 0, 0],
        [770, 1026, 252, 508, 5, 0, 0],
        [1026, 1026, 252, 508, 5, 0, 0],
        [1282, 1026, 252, 508, 5, 0, 0],
        [1538, 1026, 252, 508, 5, 0, 0],
        [1794, 1026, 252, 508, 5, 0, 0],
        [2, 1538, 252, 508, 5, 0, 0],
        [258, 1538, 252, 508, 5, 0, 0],
        [514, 1538, 252, 508, 5, 0, 0],
        [770, 1538, 252, 508, 5, 0, 0],
        [1026, 1538, 252, 508, 5, 0, 0],
        [1282, 1538, 252, 508, 5, 0, 0],
        [1538, 1538, 252, 508, 5, 0, 0],
        [1794, 1538, 252, 508, 5, 0, 0],
        [2, 2, 252, 508, 6, 0, 0],
        [258, 2, 252, 508, 6, 0, 0],
        [514, 2, 252, 508, 6, 0, 0],
        [770, 2, 252, 508, 6, 0, 0],
        [1026, 2, 252, 508, 6, 0, 0],
        [1282, 2, 252, 508, 6, 0, 0],
        [1538, 2, 252, 508, 6, 0, 0],
        [1794, 2, 252, 508, 6, 0, 0],
        [2, 514, 252, 508, 6, 0, 0],
        [258, 514, 252, 508, 6, 0, 0],
        [514, 514, 252, 508, 6, 0, 0],
        [770, 514, 252, 508, 6, 0, 0],
        [1026, 514, 252, 508, 6, 0, 0],
        [1282, 514, 252, 508, 6, 0, 0],
        [1538, 514, 252, 508, 6, 0, 0],
        [1794, 514, 252, 508, 6, 0, 0],
        [2, 1026, 252, 508, 6, 0, 0],
        [258, 1026, 252, 508, 6, 0, 0],
        [514, 1026, 252, 508, 6, 0, 0],
        [770, 1026, 252, 508, 6, 0, 0],
        [1026, 1026, 252, 508, 6, 0, 0],
        [1282, 1026, 252, 508, 6, 0, 0],
        [1538, 1026, 252, 508, 6, 0, 0],
        [1794, 1026, 252, 508, 6, 0, 0],
        [2, 1538, 252, 508, 6, 0, 0]
    ]
}


            s.fromJSON(json, function(img) {
                var object = img.set({ left: 300, top: 300});
                canvas.add(object);
                canvas.setActiveObject(object);
                setTimeout(function animate() {
                    canvas.forEachObject(function(obj){ obj.animate() });
                    canvas.renderAll();
                    setTimeout(animate, 100);
                }, 100);
                //object.applyFilters(canvas.renderAll.bind(canvas));
                canvas.fire('object:added', { target: object });
            });
        },
        addImage : function(filename,callback) {
            fabric.Image.fromURL(filename, function(img) {
                var f = fabric.Image.filters;
                var object = img.set({ left: 300, top: 300}).scale(0.9);
                object.filters.push(new f.Highpass(img_options));

                canvas.add(object);
                canvas.setActiveObject(object);
                object.applyFilters(canvas.renderAll.bind(canvas));
                canvas.fire('object:added', { target: object });
                if(callback) callback(object);
            });
        },
        changeImage : function(prop,value) {
            var f = fabric.Image.filters;
            var obj = canvas.getActiveObject();
            eval("img_options."+prop+" = value");
            obj.filters.length = 0;
            obj.filters.push(new f.Highpass(img_options));
            obj.applyFilters(canvas.renderAll.bind(canvas));
        },
        addSVG : function(filename,callback) {
            fabric.loadSVGFromURL(filename, function(objects,options) { 
                var loadedObject;
                objects.forEach(function(o) {
                    o.stroke = '#ffffff';
                    o.fill = '#000000'
                })
                 if (objects.length > 1) {
                    loadedObject = new fabric.PathGroup(objects, options);
                } else {
                    loadedObject = objects[0];
                }
                canvas.add(loadedObject);
                if(callback) callback(object);
            });
        },
        deleteItem : function() {
            function remove(o) {
                canvas.remove(o);
                canvas.fire('object:removed', { target: o });
            }
            if(canvas.getActiveGroup()){
                canvas.getActiveGroup().forEachObject(function(o){ 
                    remove(o)
                });
                canvas.discardActiveGroup().renderAll();
            } else {
                var o = canvas.getActiveObject()
                remove(o);
            }
        },
        getItem :function() {
            return JSON.stringify(canvas.toJSON());
        },
        toggleDrawing : function() {
            canvas.discardActiveGroup();
            canvas.isDrawingMode = !canvas.isDrawingMode;
            return canvas.isDrawingMode
        },
    };
});